/* eslint-disable no-debugger */
/* eslint-disable no-case-declarations */
/* eslint-disable no-undef */
// @ts-nocheck

(function(){
	const vscode = acquireVsCodeApi();
	let question = '';
	document.getElementById('query').addEventListener('keydown', function(event) {
		if (event.key === 'Enter') {
			event.preventDefault();
			question = event.target.value.trim();
			if (question) {
				vscode.postMessage({
					command: 'askLLM',
					message: {
						role: 'dreamscript',
						content: question
					}
				});
				event.target.value = '';
			}
			return false;
		}
	});
	document.addEventListener('DOMContentLoaded', (event) => {
		const loadingAnimation = document.getElementsByClassName("loadingAnimation");
		const streamedRaw = document.getElementsByClassName("streamedRaw");
		const conversation = document.getElementsByClassName("conversation")[0];
		let model = "";
        window.addEventListener('message', event => {
            const message = event.data;
            switch (message.command) {
                case 'loadMetadata':
					// const messages = document.getElementsByClassName("message");
					loadingAnimation[0].scrollIntoView();
                    break;
				////
				case 'addHTML':
					conversation.innerHTML = conversation.innerHTML + message.data;
					debugger;
                    break;
				////
				case 'startLLMResponseChunk':
					loadingAnimation[0].classList.add("in");
					break;
				case 'endLLMResponseChunk':
					loadingAnimation[0].classList.remove("in");
					
					vscode.postMessage({
						command: 'storeLLMResponse',
						message: {
							role: 'dreamscript',
							question: question,
							model: model,
							response: streamedRaw[0].innerHTML
						}
					});
					break;
                case 'addLLMResponseChunk':
					// Optimize selection
					const streamed = document.getElementsByClassName("streamed");
					const streamedRole = document.getElementsByClassName("streamedRole");
					loadingAnimation[0].classList.add("in");
					const content = event.data.data.response;
					model = event.data.data.model;
					streamedRole[0].innerHTML = "˜”*°•.˜”*°• " + model + " •°*”˜.•°*”˜";
					streamedRaw[0].innerHTML = streamedRaw[0].innerHTML + content;
					streamed[0].innerHTML = marked.parse(streamedRaw[0].innerHTML);
					// streamed[0].querySelectorAll('*').forEach(element => {
					// 	element.classList.add('fadeable');
					// 	setTimeout(() => {
					// 		element.classList.add('in');
					// 	}, 100);
					// });
					loadingAnimation[0].scrollIntoView();
					// streamed[0].innerHTML += content;
					
                    break;
            }
        });
	});
}());
