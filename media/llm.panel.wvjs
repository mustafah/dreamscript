/* eslint-disable no-debugger */
/* eslint-disable no-case-declarations */
/* eslint-disable no-undef */
// @ts-nocheck

(function(){
	const vscode = acquireVsCodeApi();
	let question = '';
	document.getElementById('query').addEventListener('keydown', function(event) {
		if (event.key === 'Enter') {
			event.preventDefault();
			question = event.target.value.trim();
			if (question) {
				vscode.postMessage({
					command: 'askLLM',
					message: {
						role: 'dreamscript',
						content: question
					}
				});
				event.target.value = '';
			}
			return false;
		}
	});
	document.addEventListener('DOMContentLoaded', (event) => {
		const loadingAnimation = document.getElementsByClassName("loadingAnimation");
		const conversation = document.getElementsByClassName("conversation")[0];
		let model = "";
		var $raw;
        window.addEventListener('message', event => {
            const message = event.data;
            switch (message.command) {
                case 'loadMetadata':
					loadingAnimation[0].scrollIntoView();
                    break;
				////
				case 'addHTML':
					const selector = document.querySelector(message.data.selector);
					selector.innerHTML = selector.innerHTML + message.data.html;
                    break;
				////
				case 'scrollToBottom':
					loadingAnimation[0].scrollIntoView();
					break;
				case 'startLLMResponseChunk':
					loadingAnimation[0].classList.add("in");
					break;
				case 'endLLMResponseChunk':
					loadingAnimation[0].classList.remove("in");
					
					var streamedRaws = document.querySelectorAll(".streamedRaw");
					var streamedRaw = streamedRaws[streamedRaws.length - 1];

					$raw = queryLatest(".raw");
					debugger
					vscode.postMessage({
						command: 'storeLLMResponse',
						message: {
							question: question,
							answer: {
								model: model,
								answer: $raw.innerHTML
							}
						}
					});
					break;
                case 'addLLMResponseChunk':
					$raw = queryLatest(".raw");
					$raw.innerHTML = $raw.innerHTML + message.data.content;
					const $marked = queryLatest(".marked");
					$marked.innerHTML = marked.parse($raw.innerHTML);
					const $model = queryLatest(".model-name");
					$model.innerHTML = model = message.data.model;
					//////
					// const streameds = document.querySelectorAll(".streamed");
					// const streamed = streameds[streameds.length - 1];

					// const streamedRoles = document.querySelectorAll(".streamedRole");
					// const streamedRole = streamedRoles[streamedRoles.length - 1];

					// streamedRaws = document.querySelectorAll(".streamedRaw");
					// streamedRaw = streamedRaws[streamedRaws.length - 1];

					// loadingAnimation[0].classList.add("in");
					// const content = message.data.response;
					// model = message.data.model;
					// streamedRole.innerHTML = "˜”*°•.˜”*°• " + model + " •°*”˜.•°*”˜";
					// streamedRaw.innerHTML = streamedRaw.innerHTML + content;
					// streamed.innerHTML = marked.parse(streamedRaw.innerHTML);
					//
					// streamed[0].querySelectorAll('*').forEach(element => {
					// 	element.classList.add('fadeable');
					// 	setTimeout(() => {
					// 		element.classList.add('in');
					// 	}, 100);
					// });
					loadingAnimation[0].scrollIntoView();
					// streamed[0].innerHTML += content;
					
                    break;
            }
        });
	});
}());

function queryLatest(selector) {
	const allElements = document.querySelectorAll(selector);
	return allElements[allElements.length - 1];
}